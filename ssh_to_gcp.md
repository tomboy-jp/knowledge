# GCPのインスタンスを作成してからSSH接続するまでの話
タイトルの通りです。
## なぜやるのか
高性能なサーバが必要になったから。  
本格的に機械学習やらKaggleやらを始めるに当たり、  
自前PCsのスペックでは限界が出てきており、何かしらの策を講じる必要が出てきました。  
自作やらBTOやらでワークステーションをこしらえるといった選択も一瞬頭を過ぎったが、  
財布と場所と次の季節を考えて、クラウドインフラを利用する流れに。
## なぜGCPなのか
対立候補としてAWS、Azureあたりが上がってくるわけですだが、  
Azureは日本語のナレッジが心許ない感じだったため最初に脱落。  
仕事でも親しみ深いAWSが大本命で「まあ、迷ったらAWSだよね」ってノリだったのですが、  
少しばかりサーベイしてみたところ、今回の用途にはあまり向いていないことが判明。  
確かにサービス運用までするなら全部入りのAWSが頭一つ抜けているのですが、  
単純な演算処理装置として用いる場合はシンプルかつ安価なGCPに軍配が上がるという結論に。  
あとは強そうなKagglerが皆GCPを使っているところもポイントでした。
## 手順
#### その1
まずはアカウントの取得とインスタンスの構築ですが、この辺りはブラウザ上での操作なので詳しくは書きません。  
「Compute Engine」の「VMインスタンス」から公式サイトが指示する通りに作成してください。    
一つ悩みどころとしてインスタンスのスペックをどうするかですが、機械学習に使う場合はハイスペックであるに越したことはありません。  
私は[この動画](https://www.youtube.com/watch?v=NHQTw-ORcSQ)を参考にして、
```
マシンタイプ: n1-standard-8（vCPU x 8、メモリ 30 GB）
ゾーン:      us-east1-b
OS:         ubuntu-1710
```
を選択しました。

#### その2
接続するには秘密鍵の設定とクラウドSDK(gcloudコマンド)の設定が必要となります。  

まずは以下のコマンドから秘密鍵を作りましょう。  
鍵名とユーザ名は適当にどうぞ。
```
$ ssh-keygen -t rsa -f ~/.ssh/$鍵名 -C $ユーザ名
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
```
パスワードは接続の際に必要になるので必ず控えておいてください。  
```
$ ls ~/.ssh
$鍵名 $鍵名.pub
```
~/.ssh以下に「$鍵名」と「$鍵名.pub」というファイルが出来ていることを確認します。
```
cat $鍵名.pub | pbcopy
```
「.pub」が付いている方のファイル内容をクリップボードにコピーし、ブラウザを立ち上げ、  
VMインスタンス画面 > $インスタンス名　> 編集 > SSH キーがX 個あります付近の「詳細」 > 項目を追加  
の順にクリックして、認証鍵全体を入力というテキストエリアに先程の内容をペーストします。  
その後に保存をクリック。  
これで秘密鍵の設定は終わりです。

#### その3
公式からGCPのSDKを取得します。
```
$ curl https://sdk.cloud.google.com | bash
```
すると、どのシェル設定ファイルに起動スクリプトを書き込むのかを聞いてきます。  
bashの人は特にこだわりがなければそのままenterでOKです。
```
$ Enter path to an rc file to update, or leave blank to use
$ [/Users/ユーザー名/.bash_profile]:
```
他のシェルを使っているユーザは各人が使用しているシェルの設定ファイルに起動スクリプトを書き込む必要があります。  
例えば私はzshユーザなのですが、以下のようなコマンドで書き込みます。  
```
$ echo "# gcloud用起動スクリプト" >> ~/.zshrc
$ echo "source /Users/tomboy/google-cloud-sdk/path.zsh.inc" >> ~/.zshrc
$ echo " /Users/tomboy/google-cloud-sdk/completion.zsh.inc" >> ~/.zshrc
```
続いてGアカウントとの接続認証を行います。  
下記のコマンド入力後、ブラウザが立ち上がるので指示の通りに。
```
gcloud auth login
```
認証が完了するとssh接続が可能になります。  
コマンドはインスタンスの接続欄のプルタブから「gcloud コマンドを表示」を選択。  
そこに記述されているのが目的のコマンドとなります。  
こんな感じのやつです。
```
$ gcloud compute --project "glossy-handler-xxxxx" ssh --zone $インスタンスの場所 $インスタンス名
```
このコマンドとパスワードを入力すれば接続できるようになるはずです。  
お疲れ様でした。
