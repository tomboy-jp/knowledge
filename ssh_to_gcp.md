# GCPのインスタンスを作成してからSSH接続するまでの話
タイトルの通りです。
## なぜやるのか
高性能なサーバが必要になったから。  
本格的に機械学習やらKaggleやらを始めるに当たり、自前のPC達(MacBookProとBTOのSandyBridgeちゃん)のスペックでは限界が出てきており、何かしらの策を講じる必要が出てきた。  
自作やらBTOやらでワークステーションをこしらえるといった選択も一瞬頭を過ぎったが、財布と場所と来たる季節を考えて、クラウドインフラを利用するお流れに。
## なぜGCPなのか
対立候補としてAWS、Azureあたりが上がってくるわけですが、  
Azureは日本語のナレッジが心許ない感じだったため即脱落。  
最初は仕事でも使っているAWSが最も身近で「まあ、迷ったらAWSだよね」って雰囲気だったのですが、念の為しっかりとサーベイしたところ、今回の用途には不向きであると判明。  
確かにサービス運用するなら全部入りのAWSが頭一つ抜けているのですが、純粋な演算処理に用いる場合はシンプルかつ低価格なGCPに軍配が上がるかと。  
あとは強そうなKagglerが皆GCPを使っているところもポイントでした。
## 手順
##### 手順1
まずはアカウントの取得とインスタンスの構築ですが、この辺りはブラウザ上での操作なので割愛します。  
ただ作るだけなら公式を読めば流れで作れるかと。  
問題があるとすればインスタンスのスペックをどうするかですが、私は[この動画](https://www.youtube.com/watch?v=NHQTw-ORcSQ)を参考にして、
```
マシンタイプ: n1-standard-8（vCPU x 8、メモリ 30 GB）
ゾーン:      us-east1-b
OS:         ubuntu-1710
```
を選択しました。
##### 手順2
GCPが提供する「gcloud」というコマンドもあるようですが、特に必要性を感じなかったので、SSHコマンドに準拠した接続を試みます。  
まずは以下のコマンドから秘密鍵を作ります。  
鍵名とユーザ名は適当にどうぞ。
```
$ ssh-keygen -t rsa -f ~/.ssh/$鍵名 -C $ユーザ名
passward:
```
パスワードは接続の際に必要になるので必ず控えておいてください。
```
$ ls ~/.ssh
$鍵名 $鍵名.pub
```
~/.ssh以下に「$鍵名」と「$鍵名.pub」というファイルが出来ていることを確認します。
```
cat $鍵名.pub | pbcopy
```
「.pub」が付いている方のファイル内容をクリップボードにコピーし、ブラウザを立ち上げ、  
VMインスタンス画面 > $インスタンス名　> 編集 > SSH キーがX 個あります付近の「詳細」 > 項目を追加  
の順にクリックして、認証鍵全体を入力というテキストエリアに先程の内容をペーストします。  
その後に保存をクリック。  
これでサーバ側の設定は終わりです。

##### 手順3
このままでもSSH接続は可能ですが、
```
ssh $ユーザ名@$外部IP -i ~/.ssh/$鍵名
```
という冗長なコマンドを打たないと接続できません。  
そこで「~/.ssh/config」に接続設定を書き込み、ショートカットコマンドを作ります。
```
vi ~/.ssh/config
```
以下を追記。
```
Host $接続名
  HostName $外部IP
  User $ユーザ名
  IdentityFile ~/.ssh/＄鍵名
```
これで、
```
ssh $接続名
```
と打った後、パスワードを入力するだけで接続できるようになります。  
お疲れ様でした。
##### 追記
これ至って普通のSSH接続だし、タイトルにGCP付ける意味なかったのでは...。
